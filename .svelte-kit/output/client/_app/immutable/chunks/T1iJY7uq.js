var k=Object.defineProperty;var f=(a,e,t)=>e in a?k(a,e,{enumerable:!0,configurable:!0,writable:!0,value:t}):a[e]=t;var o=(a,e,t)=>f(a,typeof e!="symbol"?e+"":e,t);import"./l0sNRNKZ.js";async function i(a,e={},t){return window.__TAURI_INTERNALS__.invoke(a,e,t)}class d{constructor(){o(this,"accessToken",null);o(this,"refreshToken",null);o(this,"expiresAt",null)}async initialize(){try{const e=await i("load_tokens");e&&(this.accessToken=e.accessToken,this.refreshToken=e.refreshToken,this.expiresAt=new Date(e.expiresAt).getTime())}catch(e){console.warn("Token load failed:",e)}}async setTokens(e,t,s){this.accessToken=e,this.refreshToken=t,this.expiresAt=new Date(s).getTime();try{await i("save_tokens",{accessToken:e,refreshToken:t,expiresAt:s})}catch(n){throw console.error("Token save failed:",n),n}}async clearTokens(){this.accessToken=null,this.refreshToken=null,this.expiresAt=null;try{await i("clear_tokens")}catch(e){console.warn("Token clear failed:",e)}}getAccessToken(){return this.expiresAt&&Date.now()>=this.expiresAt-6e4?null:this.accessToken}getRefreshToken(){return this.refreshToken}isAuthenticated(){return!!this.getAccessToken()}isExpiringSoon(){return this.expiresAt?Date.now()>=this.expiresAt-3e5:!0}}const r=new d;class u{constructor(e="http://localhost:8100"){o(this,"baseUrl");o(this,"refreshPromise",null);this.baseUrl=e}async login(e,t){try{const s=await fetch(`${this.baseUrl}/api/v1/auth/login`,{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify({email:e,password:t})});if(!s.ok)throw new Error(`Login failed: ${s.statusText}`);const n=await s.json();return await r.setTokens(n.access_token,n.refresh_token,n.expires_at),n}catch(s){throw await r.clearTokens(),s}}async logout(){try{r.getAccessToken()&&await fetch(`${this.baseUrl}/api/v1/auth/logout`,{method:"POST",headers:this.getAuthHeaders()})}catch(e){console.warn("Logout failed:",e)}finally{await r.clearTokens()}}async refreshAccessToken(){if(this.refreshPromise)return this.refreshPromise;this.refreshPromise=this._performRefresh();try{await this.refreshPromise}finally{this.refreshPromise=null}}async _performRefresh(){const e=r.getRefreshToken();if(!e)throw new Error("No refresh token available");try{const t=await fetch(`${this.baseUrl}/api/v1/auth/refresh`,{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify({refresh_token:e})});if(!t.ok)throw await r.clearTokens(),new Error("Token refresh failed");const s=await t.json();await r.setTokens(s.access_token,s.refresh_token,s.expires_at)}catch(t){throw await r.clearTokens(),t}}async listSkills(){return this.authenticatedFetch("/api/v1/bds/skills")}async getSkill(e){return this.authenticatedFetch(`/api/v1/bds/skills/${e}`)}async searchSkills(e){return this.authenticatedFetch(`/api/v1/bds/skills/search?query=${encodeURIComponent(e)}`)}async invokeSkill(e,t){return this.authenticatedFetch(`/api/v1/bds/skills/${e}/invoke`,{method:"POST",body:JSON.stringify(t)})}async*invokeSkillStreaming(e,t){const s=await fetch(`${this.baseUrl}/api/v1/bds/skills/${e}/invoke?stream=true`,{method:"POST",headers:this.getAuthHeaders(),body:JSON.stringify(t)});if(!s.ok)throw new Error(`Invocation failed: ${s.statusText}`);if(!s.body)throw new Error("No response body");const n=s.body.getReader(),h=new TextDecoder;try{for(;;){const{done:c,value:l}=await n.read();if(c)break;yield h.decode(l)}}finally{n.releaseLock()}}async getAuthToken(){let e=r.getAccessToken();if(!e&&(r.isExpiringSoon()&&(await this.refreshAccessToken(),e=r.getAccessToken()),!e))throw new Error("Not authenticated");return e}getAuthHeaders(){const e=r.getAccessToken();return{"Content-Type":"application/json",...e?{Authorization:`Bearer ${e}`}:{}}}async authenticatedFetch(e,t={}){await this.getAuthToken();const s=await fetch(`${this.baseUrl}${e}`,{...t,headers:{...this.getAuthHeaders(),...t.headers||{}}});if(s.status===401)try{return await this.refreshAccessToken(),this.authenticatedFetch(e,t)}catch{throw new Error("Authentication failed")}if(!s.ok)throw new Error(`API error: ${s.statusText}`);return s.json()}}const y=new u;export{y as f,r as t};
