var e=Object.defineProperty,t=(t,s,i)=>((t,s,i)=>s in t?e(t,s,{enumerable:!0,configurable:!0,writable:!0,value:i}):t[s]=i)(t,"symbol"!=typeof s?s+"":s,i);import{_ as s}from"./COvn9nVN.js";import{a as i,s as a,d as r,c as n,e as o}from"./6vB2_8ig.js";const h="forge_auth_tokens";async function c(){if("undefined"!=typeof window&&"__TAURI__"in window)try{return(await s(()=>import("./C9wVddXz.js").then(e=>e.ai),[],import.meta.url)).invoke}catch{return null}return null}const l=new class{constructor(){t(this,"accessToken",null),t(this,"refreshToken",null),t(this,"expiresAt",null),this.initialize().catch(e=>{})}async initialize(){try{if("undefined"==typeof window)return;const e=await c();if(e){const t=await e("load_tokens");t&&(this.accessToken=t.accessToken,this.refreshToken=t.refreshToken,this.expiresAt=new Date(t.expiresAt).getTime())}else{const e=localStorage.getItem(h);if(e){const t=JSON.parse(e);this.accessToken=t.accessToken,this.refreshToken=t.refreshToken,this.expiresAt=new Date(t.expiresAt).getTime()}}}catch(e){}}async setTokens(e,t,s){if(this.accessToken=e,this.refreshToken=t,this.expiresAt=new Date(s).getTime(),"undefined"!=typeof window)try{const i=await c();i?await i("save_tokens",{accessToken:e,refreshToken:t,expiresAt:s}):localStorage.setItem(h,JSON.stringify({accessToken:e,refreshToken:t,expiresAt:s}))}catch(i){throw i}}async clearTokens(){if(this.accessToken=null,this.refreshToken=null,this.expiresAt=null,"undefined"!=typeof window)try{const e=await c();e?await e("clear_tokens"):localStorage.removeItem(h)}catch(e){}}getAccessToken(){return this.expiresAt&&Date.now()>=this.expiresAt-6e4?null:this.accessToken}getRefreshToken(){return this.refreshToken}isAuthenticated(){return!!this.getAccessToken()}isExpiringSoon(){return!this.expiresAt||Date.now()>=this.expiresAt-3e5}};class u{constructor(e={}){t(this,"cache"),t(this,"maxSize"),t(this,"ttl"),t(this,"hits",0),t(this,"misses",0),this.cache=new Map,this.maxSize=e.maxSize??100,this.ttl=e.ttl??3e5}get(e){const t=this.cache.get(e);return t?Date.now()>t.expiresAt?(this.cache.delete(e),this.misses++,null):(this.cache.delete(e),this.cache.set(e,t),this.hits++,t.value):(this.misses++,null)}set(e,t,s){if(this.cache.has(e)&&this.cache.delete(e),this.cache.size>=this.maxSize){const e=this.cache.keys().next().value;void 0!==e&&this.cache.delete(e)}const i=s??this.ttl,a={value:t,expiresAt:Date.now()+i};this.cache.set(e,a)}has(e){const t=this.cache.get(e);return!!t&&(!(Date.now()>t.expiresAt)||(this.cache.delete(e),!1))}delete(e){return this.cache.delete(e)}clear(){this.cache.clear(),this.hits=0,this.misses=0}prune(){const e=Date.now();let t=0;for(const[s,i]of this.cache.entries())e>i.expiresAt&&(this.cache.delete(s),t++);return t}getStats(){return{hits:this.hits,misses:this.misses,size:this.cache.size,maxSize:this.maxSize}}getHitRate(){const e=this.hits+this.misses;return 0===e?0:this.hits/e*100}keys(){return Array.from(this.cache.keys())}size(){return this.cache.size}}function f(e,t,s){const i=[e];if(t){const e=Object.keys(t).sort().map(e=>`${e}=${JSON.stringify(t[e])}`).join("&");i.push(e)}return i.join("|")}async function d(e,t,s,i){const a=s.get(e);if(null!==a)return t().then(t=>{s.set(e,t)}).catch(e=>{}),a;const r=await t();return s.set(e,r),r}const k=new u({maxSize:50,ttl:6e5}),w=new u({maxSize:50,ttl:12e4});const y=new class{constructor(e="http://localhost:8787"){t(this,"baseUrl"),t(this,"refreshPromise",null),t(this,"maxRetries",3),t(this,"timeout",3e4),this.baseUrl=e}async retryFetch(e,t){let s=null;for(let n=0;n<this.maxRetries;n++)try{return await e()}catch(o){const e=i(o);if(s=e,!a(e,n,this.maxRetries))throw e;const t=r(e,n);await new Promise(e=>setTimeout(e,t))}throw s||n(`${t} failed after ${this.maxRetries} attempts`)}async fetchWithTimeout(e,t={}){const s=new AbortController,i=setTimeout(()=>s.abort(),this.timeout);try{const i=Date.now(),a=await fetch(e,{...t,signal:s.signal});Date.now();return a}catch(a){if("AbortError"===a.name)throw n("Request timeout",`Request to ${e} timed out after ${this.timeout}ms`);throw a}finally{clearTimeout(i)}}async login(e,t){return this.retryFetch(async()=>{try{const s=await this.fetchWithTimeout(`${this.baseUrl}/api/v1/auth/login`,{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify({email:e,password:t})});if(!s.ok){const e=i(s);throw await l.clearTokens(),e}const a=await s.json();return await l.setTokens(a.access_token,a.refresh_token,a.expires_at),a}catch(s){throw await l.clearTokens(),i(s)}},"Login")}async logout(){try{l.getAccessToken()&&await fetch(`${this.baseUrl}/api/v1/auth/logout`,{method:"POST",headers:this.getAuthHeaders()})}catch(e){}finally{await l.clearTokens()}}async refreshAccessToken(){if(this.refreshPromise)return this.refreshPromise;this.refreshPromise=this._performRefresh();try{await this.refreshPromise}finally{this.refreshPromise=null}}async _performRefresh(){const e=l.getRefreshToken();if(!e)throw new Error("No refresh token available");try{const t=await fetch(`${this.baseUrl}/api/v1/auth/refresh`,{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify({refresh_token:e})});if(!t.ok)throw await l.clearTokens(),new Error("Token refresh failed");const s=await t.json();await l.setTokens(s.access_token,s.refresh_token,s.expires_at)}catch(t){throw await l.clearTokens(),t}}async listSkills(e){const t=f("/api/v1/bds/skills");if(null==e?void 0:e.skipCache){const e=await this.authenticatedFetch("/api/v1/bds/skills");return k.set(t,e),e}return d(t,()=>this.authenticatedFetch("/api/v1/bds/skills"),k)}async getSkill(e,t){const s=f(`/api/v1/bds/skills/${e}`);if(null==t?void 0:t.skipCache){const t=await this.authenticatedFetch(`/api/v1/bds/skills/${e}`);return k.set(s,t),t}return d(s,()=>this.authenticatedFetch(`/api/v1/bds/skills/${e}`),k)}async searchSkills(e,t){const s=f("/api/v1/bds/skills/search",{query:e});if(null==t?void 0:t.skipCache){const t=await this.authenticatedFetch(`/api/v1/bds/skills/search?query=${encodeURIComponent(e)}`);return w.set(s,t),t}return d(s,()=>this.authenticatedFetch(`/api/v1/bds/skills/search?query=${encodeURIComponent(e)}`),w)}async invokeSkill(e,t){return this.authenticatedFetch(`/api/v1/bds/skills/${e}/invoke`,{method:"POST",body:JSON.stringify(t)})}async*invokeSkillStreaming(e,t){let s=null;try{const r=await this.fetchWithTimeout(`${this.baseUrl}/api/v1/bds/skills/${e}/invoke?stream=true`,{method:"POST",headers:this.getAuthHeaders(),body:JSON.stringify(t)});if(!r.ok)throw i(r);if(!r.body)throw n("No response body","Streaming response has no body");s=r.body.getReader();const o=new TextDecoder;let h="";for(;;){const{done:e,value:t}=await s.read();if(e){if(h.trim()){const e=h.split("\n");for(const t of e){const e=t.trim();if(e.startsWith("data: ")){const t=e.substring(6);try{const e=JSON.parse(t);e.token?yield{type:"token",data:e}:e.metadata&&(yield{type:"metadata",data:e.metadata})}catch(a){}}}}break}h+=o.decode(t,{stream:!0});const i=h.split("\n");h=i.pop()||"";for(const s of i){const e=s.trim();if(e.startsWith("data: ")){const t=e.substring(6);try{const e=JSON.parse(t);void 0!==e.token?yield{type:"token",data:e}:e.metadata?yield{type:"metadata",data:e.metadata}:e.error&&(yield{type:"error",data:e.error})}catch(a){}}}}}catch(r){throw i(r)}finally{if(s)try{s.releaseLock()}catch(a){}}}async getAuthToken(){let e=l.getAccessToken();if(!e&&(l.isExpiringSoon()&&(await this.refreshAccessToken(),e=l.getAccessToken()),!e))throw new Error("Not authenticated");return e}getAuthHeaders(){const e=l.getAccessToken();return{"Content-Type":"application/json",...e?{Authorization:`Bearer ${e}`}:{}}}async authenticatedFetch(e,t={}){return this.retryFetch(async()=>{try{await this.getAuthToken();const a=await this.fetchWithTimeout(`${this.baseUrl}${e}`,{...t,headers:{...this.getAuthHeaders(),...t.headers||{}}});if(401===a.status)try{await this.refreshAccessToken();const s=await this.fetchWithTimeout(`${this.baseUrl}${e}`,{...t,headers:{...this.getAuthHeaders(),...t.headers||{}}});if(!s.ok)throw i(s);return s.json()}catch(s){throw o("Authentication failed after token refresh")}if(!a.ok)throw i(a);return a.json()}catch(a){throw i(a)}},`API request to ${e}`)}};export{y as f,l as t};
