var k=Object.defineProperty;var u=(n,e,s)=>e in n?k(n,e,{enumerable:!0,configurable:!0,writable:!0,value:s}):n[e]=s;var a=(n,e,s)=>u(n,typeof e!="symbol"?e+"":e,s);async function l(n,e={},s){return window.__TAURI_INTERNALS__.invoke(n,e,s)}class d{constructor(){a(this,"accessToken",null);a(this,"refreshToken",null);a(this,"expiresAt",null)}async initialize(){try{const e=await l("load_tokens");e&&(this.accessToken=e.accessToken,this.refreshToken=e.refreshToken,this.expiresAt=new Date(e.expiresAt).getTime())}catch(e){console.warn("Token load failed:",e)}}async setTokens(e,s,t){this.accessToken=e,this.refreshToken=s,this.expiresAt=new Date(t).getTime();try{await l("save_tokens",{accessToken:e,refreshToken:s,expiresAt:t})}catch(r){throw console.error("Token save failed:",r),r}}async clearTokens(){this.accessToken=null,this.refreshToken=null,this.expiresAt=null;try{await l("clear_tokens")}catch(e){console.warn("Token clear failed:",e)}}getAccessToken(){return this.expiresAt&&Date.now()>=this.expiresAt-6e4?null:this.accessToken}getRefreshToken(){return this.refreshToken}isAuthenticated(){return!!this.getAccessToken()}isExpiringSoon(){return this.expiresAt?Date.now()>=this.expiresAt-3e5:!0}}const i=new d;class f{constructor(e="http://localhost:8100"){a(this,"baseUrl");a(this,"refreshPromise",null);this.baseUrl=e}async login(e,s){try{const t=await fetch(`${this.baseUrl}/api/v1/auth/login`,{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify({email:e,password:s})});if(!t.ok)throw new Error(`Login failed: ${t.statusText}`);const r=await t.json();return await i.setTokens(r.access_token,r.refresh_token,r.expires_at),r}catch(t){throw await i.clearTokens(),t}}async logout(){try{i.getAccessToken()&&await fetch(`${this.baseUrl}/api/v1/auth/logout`,{method:"POST",headers:this.getAuthHeaders()})}catch(e){console.warn("Logout failed:",e)}finally{await i.clearTokens()}}async refreshAccessToken(){if(this.refreshPromise)return this.refreshPromise;this.refreshPromise=this._performRefresh();try{await this.refreshPromise}finally{this.refreshPromise=null}}async _performRefresh(){const e=i.getRefreshToken();if(!e)throw new Error("No refresh token available");try{const s=await fetch(`${this.baseUrl}/api/v1/auth/refresh`,{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify({refresh_token:e})});if(!s.ok)throw await i.clearTokens(),new Error("Token refresh failed");const t=await s.json();await i.setTokens(t.access_token,t.refresh_token,t.expires_at)}catch(s){throw await i.clearTokens(),s}}async listSkills(){return this.authenticatedFetch("/api/v1/bds/skills")}async getSkill(e){return this.authenticatedFetch(`/api/v1/bds/skills/${e}`)}async searchSkills(e){return this.authenticatedFetch(`/api/v1/bds/skills/search?query=${encodeURIComponent(e)}`)}async invokeSkill(e,s){return this.authenticatedFetch(`/api/v1/bds/skills/${e}/invoke`,{method:"POST",body:JSON.stringify(s)})}async*invokeSkillStreaming(e,s){const t=await fetch(`${this.baseUrl}/api/v1/bds/skills/${e}/invoke?stream=true`,{method:"POST",headers:this.getAuthHeaders(),body:JSON.stringify(s)});if(!t.ok)throw new Error(`Invocation failed: ${t.statusText}`);if(!t.body)throw new Error("No response body");const r=t.body.getReader(),o=new TextDecoder;try{for(;;){const{done:c,value:h}=await r.read();if(c)break;yield o.decode(h)}}finally{r.releaseLock()}}async getAuthToken(){let e=i.getAccessToken();if(!e&&(i.isExpiringSoon()&&(await this.refreshAccessToken(),e=i.getAccessToken()),!e))throw new Error("Not authenticated");return e}getAuthHeaders(){const e=i.getAccessToken();return{"Content-Type":"application/json",...e?{Authorization:`Bearer ${e}`}:{}}}async authenticatedFetch(e,s={}){await this.getAuthToken();const t=await fetch(`${this.baseUrl}${e}`,{...s,headers:{...this.getAuthHeaders(),...s.headers||{}}});if(t.status===401)try{return await this.refreshAccessToken(),this.authenticatedFetch(e,s)}catch{throw new Error("Authentication failed")}if(!t.ok)throw new Error(`API error: ${t.statusText}`);return t.json()}}const w=new f;class g{constructor(){a(this,"allSkills",[]);a(this,"skillsLoaded",!1);a(this,"loadingPromise",null)}async loadSkills(){return this.skillsLoaded?this.allSkills:this.loadingPromise?this.loadingPromise:(this.loadingPromise=w.listSkills().then(e=>(this.allSkills=e.skills,this.skillsLoaded=!0,this.allSkills)),this.loadingPromise)}async getAllSkills(){return this.loadSkills()}async getSkill(e){return(await this.getAllSkills()).find(t=>t.id===e)}async getSkillsBySection(){return(await this.getAllSkills()).reduce((s,t)=>(s[t.section]||(s[t.section]=[]),s[t.section].push(t),s),{})}async getSkillsByCategory(){return(await this.getAllSkills()).reduce((s,t)=>(s[t.category]||(s[t.category]=[]),s[t.category].push(t),s),{})}async search(e){const s=await this.getAllSkills(),t=e.toLowerCase();return s.filter(r=>r.name.toLowerCase().includes(t)||r.description.toLowerCase().includes(t)||r.tags.some(o=>o.toLowerCase().includes(t)))}async getPublicSkills(){return(await this.getAllSkills()).filter(s=>s.access==="PUBLIC")}async getBDSOnlySkills(){return(await this.getAllSkills()).filter(s=>s.access==="BDS_ONLY")}clearCache(){this.allSkills=[],this.skillsLoaded=!1,this.loadingPromise=null}}const T=new g;export{w as f,T as s,i as t};
