import{e,c as t}from"../../../chunks/vendor.js";import{c as s,s as i,a,b as l,d as c}from"../../../chunks/errors.js";import{B as r}from"../../../chunks/Button.js";import{P as n}from"../../../chunks/Panel.js";import{B as o}from"../../../chunks/Badge.js";import{A as h}from"../../../chunks/Alert.js";const d="forge_auth_tokens";async function u(){if("undefined"!=typeof window&&"__TAURI__"in window)try{return(await import("@tauri-apps/api/core")).invoke}catch{return null}return null}const k=new class{accessToken=null;refreshToken=null;expiresAt=null;constructor(){this.initialize().catch(e=>{})}async initialize(){try{if("undefined"==typeof window)return;const e=await u();if(e){const t=await e("load_tokens");t&&(this.accessToken=t.accessToken,this.refreshToken=t.refreshToken,this.expiresAt=new Date(t.expiresAt).getTime())}else{const e=localStorage.getItem(d);if(e){const t=JSON.parse(e);this.accessToken=t.accessToken,this.refreshToken=t.refreshToken,this.expiresAt=new Date(t.expiresAt).getTime()}}}catch(e){}}async setTokens(e,t,s){if(this.accessToken=e,this.refreshToken=t,this.expiresAt=new Date(s).getTime(),"undefined"!=typeof window)try{const i=await u();i?await i("save_tokens",{accessToken:e,refreshToken:t,expiresAt:s}):localStorage.setItem(d,JSON.stringify({accessToken:e,refreshToken:t,expiresAt:s}))}catch(i){throw i}}async clearTokens(){if(this.accessToken=null,this.refreshToken=null,this.expiresAt=null,"undefined"!=typeof window)try{const e=await u();e?await e("clear_tokens"):localStorage.removeItem(d)}catch(e){}}getAccessToken(){return this.expiresAt&&Date.now()>=this.expiresAt-6e4?null:this.accessToken}getRefreshToken(){return this.refreshToken}isAuthenticated(){return!!this.getAccessToken()}isExpiringSoon(){return!this.expiresAt||Date.now()>=this.expiresAt-3e5}};class p{cache;maxSize;ttl;hits=0;misses=0;constructor(e={}){this.cache=new Map,this.maxSize=e.maxSize??100,this.ttl=e.ttl??3e5}get(e){const t=this.cache.get(e);return t?Date.now()>t.expiresAt?(this.cache.delete(e),this.misses++,null):(this.cache.delete(e),this.cache.set(e,t),this.hits++,t.value):(this.misses++,null)}set(e,t,s){if(this.cache.has(e)&&this.cache.delete(e),this.cache.size>=this.maxSize){const e=this.cache.keys().next().value;void 0!==e&&this.cache.delete(e)}const i=s??this.ttl,a={value:t,expiresAt:Date.now()+i};this.cache.set(e,a)}has(e){const t=this.cache.get(e);return!!t&&(!(Date.now()>t.expiresAt)||(this.cache.delete(e),!1))}delete(e){return this.cache.delete(e)}clear(){this.cache.clear(),this.hits=0,this.misses=0}prune(){const e=Date.now();let t=0;for(const[s,i]of this.cache.entries())e>i.expiresAt&&(this.cache.delete(s),t++);return t}getStats(){return{hits:this.hits,misses:this.misses,size:this.cache.size,maxSize:this.maxSize}}getHitRate(){const e=this.hits+this.misses;return 0===e?0:this.hits/e*100}keys(){return Array.from(this.cache.keys())}size(){return this.cache.size}}function f(e,t,s){const i=[e];if(t){const e=Object.keys(t).sort().map(e=>`${e}=${JSON.stringify(t[e])}`).join("&");i.push(e)}return i.join("|")}async function m(e,t,s,i){const a=s.get(e);if(null!==a)return t().then(t=>{s.set(e,t)}).catch(e=>{}),a;const l=await t();return s.set(e,l),l}const g=new p({maxSize:50,ttl:6e5}),y=new p({maxSize:50,ttl:12e4});const w=new class{baseUrl;refreshPromise=null;maxRetries=3;timeout=3e4;constructor(e="http://localhost:8787"){this.baseUrl=e}async retryFetch(e,t){let c=null;for(let l=0;l<this.maxRetries;l++)try{return await e()}catch(r){const e=s(r);if(c=e,!i(e,l,this.maxRetries))throw e;const t=a(e,l);await new Promise(e=>setTimeout(e,t))}throw c||l(`${t} failed after ${this.maxRetries} attempts`)}async fetchWithTimeout(e,t={}){const s=new AbortController,i=setTimeout(()=>s.abort(),this.timeout);try{const i=Date.now(),a=await fetch(e,{...t,signal:s.signal});Date.now();return a}catch(a){if("AbortError"===a.name)throw l("Request timeout",`Request to ${e} timed out after ${this.timeout}ms`);throw a}finally{clearTimeout(i)}}async login(e,t){return this.retryFetch(async()=>{try{const i=await this.fetchWithTimeout(`${this.baseUrl}/api/v1/auth/login`,{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify({email:e,password:t})});if(!i.ok){const e=s(i);throw await k.clearTokens(),e}const a=await i.json();return await k.setTokens(a.access_token,a.refresh_token,a.expires_at),a}catch(i){throw await k.clearTokens(),s(i)}},"Login")}async logout(){try{k.getAccessToken()&&await fetch(`${this.baseUrl}/api/v1/auth/logout`,{method:"POST",headers:this.getAuthHeaders()})}catch(e){}finally{await k.clearTokens()}}async refreshAccessToken(){if(this.refreshPromise)return this.refreshPromise;this.refreshPromise=this._performRefresh();try{await this.refreshPromise}finally{this.refreshPromise=null}}async _performRefresh(){const e=k.getRefreshToken();if(!e)throw new Error("No refresh token available");try{const t=await fetch(`${this.baseUrl}/api/v1/auth/refresh`,{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify({refresh_token:e})});if(!t.ok)throw await k.clearTokens(),new Error("Token refresh failed");const s=await t.json();await k.setTokens(s.access_token,s.refresh_token,s.expires_at)}catch(t){throw await k.clearTokens(),t}}async listSkills(e){const t=f("/api/v1/bds/skills");if(e?.skipCache){const e=await this.authenticatedFetch("/api/v1/bds/skills");return g.set(t,e),e}return m(t,()=>this.authenticatedFetch("/api/v1/bds/skills"),g)}async getSkill(e,t){const s=f(`/api/v1/bds/skills/${e}`);if(t?.skipCache){const t=await this.authenticatedFetch(`/api/v1/bds/skills/${e}`);return g.set(s,t),t}return m(s,()=>this.authenticatedFetch(`/api/v1/bds/skills/${e}`),g)}async searchSkills(e,t){const s=f("/api/v1/bds/skills/search",{query:e});if(t?.skipCache){const t=await this.authenticatedFetch(`/api/v1/bds/skills/search?query=${encodeURIComponent(e)}`);return y.set(s,t),t}return m(s,()=>this.authenticatedFetch(`/api/v1/bds/skills/search?query=${encodeURIComponent(e)}`),y)}async invokeSkill(e,t){return this.authenticatedFetch(`/api/v1/bds/skills/${e}/invoke`,{method:"POST",body:JSON.stringify(t)})}async*invokeSkillStreaming(e,t){let i=null;try{const c=await this.fetchWithTimeout(`${this.baseUrl}/api/v1/bds/skills/${e}/invoke?stream=true`,{method:"POST",headers:this.getAuthHeaders(),body:JSON.stringify(t)});if(!c.ok)throw s(c);if(!c.body)throw l("No response body","Streaming response has no body");i=c.body.getReader();const r=new TextDecoder;let n="";for(;;){const{done:e,value:t}=await i.read();if(e){if(n.trim()){const e=n.split("\n");for(const t of e){const e=t.trim();if(e.startsWith("data: ")){const t=e.substring(6);try{const e=JSON.parse(t);e.token?yield{type:"token",data:e}:e.metadata&&(yield{type:"metadata",data:e.metadata})}catch(a){}}}}break}n+=r.decode(t,{stream:!0});const s=n.split("\n");n=s.pop()||"";for(const i of s){const e=i.trim();if(e.startsWith("data: ")){const t=e.substring(6);try{const e=JSON.parse(t);void 0!==e.token?yield{type:"token",data:e}:e.metadata?yield{type:"metadata",data:e.metadata}:e.error&&(yield{type:"error",data:e.error})}catch(a){}}}}}catch(c){throw s(c)}finally{if(i)try{i.releaseLock()}catch(a){}}}async getAuthToken(){let e=k.getAccessToken();if(!e&&(k.isExpiringSoon()&&(await this.refreshAccessToken(),e=k.getAccessToken()),!e))throw new Error("Not authenticated");return e}getAuthHeaders(){const e=k.getAccessToken();return{"Content-Type":"application/json",...e?{Authorization:`Bearer ${e}`}:{}}}async authenticatedFetch(e,t={}){return this.retryFetch(async()=>{try{await this.getAuthToken();const a=await this.fetchWithTimeout(`${this.baseUrl}${e}`,{...t,headers:{...this.getAuthHeaders(),...t.headers||{}}});if(401===a.status)try{await this.refreshAccessToken();const i=await this.fetchWithTimeout(`${this.baseUrl}${e}`,{...t,headers:{...this.getAuthHeaders(),...t.headers||{}}});if(!i.ok)throw s(i);return i.json()}catch(i){throw c("Authentication failed after token refresh")}if(!a.ok)throw s(a);return a.json()}catch(a){throw s(a)}},`API request to ${e}`)}};const v=new class{allSkills=[];skillsLoaded=!1;loadingPromise=null;async loadSkills(){return this.skillsLoaded?this.allSkills:(this.loadingPromise||(this.loadingPromise=w.listSkills().then(e=>(this.allSkills=e.skills,this.skillsLoaded=!0,this.allSkills))),this.loadingPromise)}async getAllSkills(){return this.loadSkills()}async getSkill(e){return(await this.getAllSkills()).find(t=>t.id===e)}async getSkillsBySection(){return(await this.getAllSkills()).reduce((e,t)=>(e[t.section]||(e[t.section]=[]),e[t.section].push(t),e),{})}async getSkillsByCategory(){return(await this.getAllSkills()).reduce((e,t)=>(e[t.category]||(e[t.category]=[]),e[t.category].push(t),e),{})}async search(e){const t=await this.getAllSkills(),s=e.toLowerCase();return t.filter(e=>e.name.toLowerCase().includes(s)||e.description.toLowerCase().includes(s)||e.tags.some(e=>e.toLowerCase().includes(s)))}async getPublicSkills(){return(await this.getAllSkills()).filter(e=>"PUBLIC"===e.access)}async getBDSOnlySkills(){return(await this.getAllSkills()).filter(e=>"BDS_ONLY"===e.access)}clearCache(){this.allSkills=[],this.skillsLoaded=!1,this.loadingPromise=null}};function S(s,i){s.component(s=>{let i=[],a=!1,l="";function c(e,t,s,a){i=[...i,{test:e,status:t,message:s,data:a,timestamp:(new Date).toISOString()}]}if(s.push('<div class="test-page svelte-c3a646"><div class="test-header svelte-c3a646"><h1 class="test-title svelte-c3a646">ForgeAgents API Integration Test</h1> <p class="test-description svelte-c3a646">This page tests the connection between VibeForge_BDS frontend and the ForgeAgents BDS API.</p> <div class="test-actions svelte-c3a646">'),r(s,{variant:"primary",onclick:async function(){i=[],a=!0;try{l="Loading PUBLIC skills without authentication...";try{const e=await v.getAllSkills();c("Public Skills (No Auth)","success",`Loaded ${e.length} skills`,e.slice(0,3))}catch(e){c("Public Skills (No Auth)","error",e.message,e)}l="Authenticating as admin@bds.com...";try{const e=await w.login("admin@bds.com","password123");c("Authentication","success",`Logged in successfully (expires: ${e.expires_at})`,{token_type:e.token_type,expires_in:e.expires_in,access_token:e.access_token.slice(0,50)+"..."})}catch(e){c("Authentication","error",e.message,e)}l="Loading ALL skills with authentication...";try{const e=await w.listSkills();c("All Skills (With Auth)","success",`Loaded ${e.skills.length} skills`,e.skills.slice(0,3))}catch(e){c("All Skills (With Auth)","error",e.message,e)}l="Fetching specific skill...";try{const e=await w.getSkill("A1");c("Get Skill (A1)","success",`Retrieved skill: ${e.name}`,e)}catch(e){c("Get Skill (A1)","error",e.message,e)}l="Invoking skill...";try{c("Invoke Skill (A1)","success","Invocation completed",await w.invokeSkill("A1",{prompt:"Test prompt for API integration",context:{},temperature:.7,stream:!1}))}catch(e){c("Invoke Skill (A1)","error",e.message,e)}}finally{a=!1,l=""}},disabled:a,children:e=>{e.push(`\x3c!----\x3e${t(a?"Running Tests...":"Run All Tests")}`)},$$slots:{default:!0}}),s.push("\x3c!----\x3e "),r(s,{variant:"secondary",onclick:function(){i=[]},disabled:a,children:e=>{e.push("\x3c!----\x3eClear Results")},$$slots:{default:!0}}),s.push("\x3c!----\x3e</div> "),a?(s.push("\x3c!--[--\x3e"),h(s,{variant:"info",title:"Testing in progress",children:e=>{e.push(`\x3c!----\x3e${t(l)}`)},$$slots:{default:!0}})):s.push("\x3c!--[!--\x3e"),s.push('\x3c!--]--\x3e</div> <div class="test-results svelte-c3a646">'),0===i.length)s.push("\x3c!--[--\x3e"),n(s,{variant:"bordered",padding:"lg",children:e=>{e.push('<div class="empty-state svelte-c3a646"><p>No test results yet. Click "Run All Tests" to begin.</p></div>')},$$slots:{default:!0}});else{s.push("\x3c!--[!--\x3e"),s.push("\x3c!--[--\x3e");const a=e(i);for(let e=0,i=a.length;e<i;e++){let i=a[e];n(s,{variant:"bordered",padding:"lg",children:e=>{e.push(`<div class="result-header svelte-c3a646"><div class="result-info svelte-c3a646"><h3 class="result-test svelte-c3a646">${t(i.test)}</h3> <span class="result-time svelte-c3a646">${t(new Date(i.timestamp).toLocaleTimeString())}</span></div> `),o(e,{variant:"success"===i.status?"success":"error",children:e=>{e.push(`\x3c!----\x3e${t(i.status.toUpperCase())}`)},$$slots:{default:!0}}),e.push(`\x3c!----\x3e</div> <p class="result-message svelte-c3a646">${t(i.message)}</p> `),i.data?(e.push("\x3c!--[--\x3e"),e.push(`<details class="result-details svelte-c3a646"><summary class="svelte-c3a646">View Data</summary> <pre class="result-data svelte-c3a646">${t(JSON.stringify(i.data,null,2))}</pre></details>`)):e.push("\x3c!--[!--\x3e"),e.push("\x3c!--]--\x3e")},$$slots:{default:!0}})}s.push("\x3c!--]--\x3e")}s.push('\x3c!--]--\x3e</div> <div class="test-info svelte-c3a646">'),n(s,{variant:"bordered",padding:"lg",children:e=>{e.push('<h3 class="info-title svelte-c3a646">Test Information</h3> <dl class="info-list svelte-c3a646"><dt class="svelte-c3a646">API Base URL:</dt> <dd class="svelte-c3a646"><code class="svelte-c3a646">http://localhost:3000</code></dd> <dt class="svelte-c3a646">Test Credentials:</dt> <dd class="svelte-c3a646"><code class="svelte-c3a646">admin@bds.com</code> / <code class="svelte-c3a646">password123</code></dd> <dt class="svelte-c3a646">Expected Results:</dt> <dd class="svelte-c3a646"><ul class="svelte-c3a646"><li class="svelte-c3a646">Test 1: Should load ~67 PUBLIC skills</li> <li class="svelte-c3a646">Test 2: Should authenticate successfully</li> <li class="svelte-c3a646">Test 3: Should load all 120 skills (67 PUBLIC + 53 BDS_ONLY)</li> <li class="svelte-c3a646">Test 4: Should retrieve specific skill details</li> <li class="svelte-c3a646">Test 5: Should invoke skill and get response</li></ul></dd> <dt class="svelte-c3a646">Console Logging:</dt> <dd class="svelte-c3a646">Open browser DevTools Console to see detailed request/response logs</dd></dl>')},$$slots:{default:!0}}),s.push("\x3c!----\x3e</div></div>")})}export{S as default};
