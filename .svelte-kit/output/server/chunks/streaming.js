import{b as t,a as e}from"./errors.js";var a=(t=>(t.PLAN="PLAN",t.ACT="ACT",t.OBSERVE="OBSERVE",t.REFLECT="REFLECT",t.TRANSITION="TRANSITION",t))(a||{}),s=(t=>(t.PENDING="PENDING",t.RUNNING="RUNNING",t.COMPLETED="COMPLETED",t.FAILED="FAILED",t.CANCELLED="CANCELLED",t))(s||{}),n=(t=>(t.PENDING="PENDING",t.RUNNING="RUNNING",t.COMPLETED="COMPLETED",t.FAILED="FAILED",t.PARTIAL="PARTIAL",t))(n||{});const r=new class{activeStreams=new Map;subscribe(a,s={}){const{onChunk:n,onStageStart:r,onStageEnd:c,onComplete:o,onError:i,reconnect:l=!0,reconnectDelay:E=3e3,maxReconnectAttempts:d=5}=s;let N=null,u=0,L=!1,p=!1,S=null;const m=()=>{if(!p)try{N=new EventSource(a),this.activeStreams.set(a,N),N.addEventListener("chunk",t=>{if(!L&&!p)try{const e=JSON.parse(t.data);if("chunk"===e.type&&"object"==typeof e.data&&null!==e.data){const t=e.data;t.content&&n&&n(t.content)}}catch(e){}}),N.addEventListener("stage_start",t=>{if(!L&&!p)try{const e=JSON.parse(t.data);if("stage_start"===e.type&&"object"==typeof e.data&&null!==e.data){const t=e.data;t.stage&&r&&r(t.stage)}}catch(e){}}),N.addEventListener("stage_end",t=>{if(!L&&!p)try{const e=JSON.parse(t.data);if("stage_end"===e.type&&"object"==typeof e.data&&null!==e.data){const t=e.data;t.stage&&c&&c(t.stage,t.output)}}catch(e){}}),N.addEventListener("complete",t=>{if(!L&&!p)try{const e=JSON.parse(t.data);if("complete"===e.type&&"object"==typeof e.data&&null!==e.data){const t=e.data;o&&o(t.result)}}catch(e){}finally{A()}}),N.addEventListener("error",()=>{if(p)return;const e=t("Stream connection error");l&&u<d?(u++,N?.close(),this.activeStreams.delete(a),S=setTimeout(()=>{m()},E)):(i&&i(e),A())}),N.addEventListener("open",()=>{u=0})}catch(s){const t=e(s);i&&i(t),A()}},A=()=>{p=!0,L=!1,S&&(clearTimeout(S),S=null),N&&(N.close(),this.activeStreams.delete(a),N=null)};return m(),{close:A,pause:()=>{L=!0},resume:()=>{L=!1},get isActive(){return!p&&null!==N},get isPaused(){return L}}}closeAll(){this.activeStreams.forEach(t=>{t.close()}),this.activeStreams.clear()}get activeStreamCount(){return this.activeStreams.size}};export{a as P,s as S,n as W,r as s};
